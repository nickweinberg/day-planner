<style type="text/css">
  #svg-container {
    height: 700px;
    width: 700px;
  }

  input[type='text'] {
    width: 100%;
  }
  
</style>
<!-- Button trigger modal -->
<button class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">
  Add An Event
</button>

<button id="randomize" class="btn btn-warn btn-lg">Add Random</button>
<div id="svg-container">
  
</div>

<div class="footer">
  <p>Daily Planner</p>
</div>
<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">Create an Event</h4>
      </div>
      <div class="modal-body">
        <div class="input-group">
          <span class="input-group-addon">Start</span><input type="text" id="start" />
        </div>
        <div class="input-group">
          <span class="input-group-addon">End</span><input type="text" id="end" />
        </div>
        <div class="input-group"> 
          <span class="input-group-addon">Name</span><input type="text" id="name" />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" id="save-button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>


<script>

$(document).ready(function() {
// remember to declare all your variables up here first
var $container = $('#svg-container');
var svgWidth = $container.innerWidth(),
    svgHeight = $container.innerHeight(),
    leftMargin = 75, // so event rectangles don't cover time text
    borderSize = 3
    eventCanvasWidth = svgWidth - leftMargin,
    events = [];

// hardcoded array of objects with event details
/*
function createRandomEvents () {
var events = [
                {
                  name: 'early',
                  start: 0,
                  end: 1
                },
                {
                  name: 'other',
                  start: 3,
                  end: 4
                },
                {
                  name : 'breakfast 2',
                  start: 7,
                  end  : 9,
                  isPlaced: false
                },
                {
                  name : 'breakfast',
                  start: 8,
                  end  : 9,
                  isPlaced: false
                },
                {
                  name : 'lunch',
                  start: 12,
                  end  : 18,
                  isPlaced: false
                },
                                {
                  name: 'book club',
                  start: 2,
                  end  : 20
                },
                {
                  name : 'house party',
                  start: 18,
                  end  : 22,
                  isPlaced: false
                },
                {
                  name: 'watch out!',
                  start: 16,
                  end  : 18
                },
                

            ];
  return events;
}
*/

var createRandomEvents = function () {
  // create random data in form
  // [ { name: 'random', start: int 0-23, end: int larger than start
  // 0-23}];
  var start,
      end;

  function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1) + min);
  }

  // create a random event
    start = getRandomInt(0,22);
    end   = getRandomInt(start + 1, 23);
    events.push({
      name : 'random event',
      start: start,
      end  : end
    }); 
  
  return;
};

// an array of objects holding how many events occur in an hour
// has 'total' amount of events that occur in that hour
// and 'current' which is the amount of events on chart currently
// this is for calculating the x position and width correctly

var eventsInHour = {};

var eventsInTimeframe = function(event, query) {
  // query is string, should be either 'current' or 'total'
  var currentLargest = 0, i;

  // should check here
  if (query !== 'total' && query !== 'current') {
    alert('query should be total or current');
    return;
  }

  for (i=event.start;i<=event.end;i+=1) {
    if (eventsInHour[i][query] > currentLargest) {
      currentLargest = eventsInHour[i][query];
    }
  }

  return currentLargest;
};

var getWidth = function (event) {
  // goes through hours
  // width is equal to largest amount of total events that occur in
  // a time frame
  var currentLargest = eventsInTimeframe(event, 'total');

  var elementWidth = Math.floor(eventCanvasWidth / currentLargest);

  event.width = elementWidth;

  console.log(elementWidth);
  // calculate width, floor for edge cases
  return elementWidth;
};


// updates events An Hour
var createEventsInHours = function () {
  // iterate through each event marking its hours
  for (var j=0; j<events.length; j+=1) {
    var event = events[j];

    for (var i=event.start;i<=event.end;i+=1) {
      // if eventsInHour has that hour
      if (i in eventsInHour) {
        eventsInHour[i].total += 1;
      } else {
        // create new object in eventsInHour
        eventsInHour[i] = {total: 1, current: 0};
      }
    }
  }
  
  // go through and assign total max width per element
  // per houra
  $.each(eventsInHour, function (index) {
    
    eventsInHour[index].maxWidthPerElement = Math.floor(eventCanvasWidth / eventsInHour[index].total);
    eventsInHour[index].widthLeft = eventCanvasWidth;
  });

  console.log(eventsInHour);
  return;
};

var updateHours = function(event) {
  // update
    for (var i=event.start;i<=event.end;i+=1) {
      eventsInHour[i].current += 1;
    }

}


var setup = function() {
  // sets everything up

  var y = d3.time.scale()
            .domain([0,24])
            .range([0, svgHeight]);

  y.ticks(d3.time.hour, 1);
    // SVG we will draw to
  
  var svg = d3.select('#svg-container')
              .append('svg')
              .attr('class', 'chart')
              .attr('width', svgWidth)
              .attr('height', svgHeight)

  var axisGroup = svg.append('g')

  // Draw y-axis ticks
  axisGroup.selectAll('.axis')
           .data(d3.range(0, 24)) // 24 hours
           .enter().append('line')
           .attr('x1', -5)
           // Round and add 0.5 to fix anti-aliasing effects
           .attr("y1", function(d) { return y(d) + 0.5; })
           .attr("x2", svgWidth)
           .attr("y2", function(d) { return y(d)+ 0.5; })
           .attr("stroke", "lightgray")
           .attr("class", "yTicks");
           
  // Draw y-axis labels of hours
  axisGroup.selectAll("text.yAxisLeft")
          .data(d3.range(0, 24))
          .enter()
          .append("text")
          .text(function(d) { return d + ":00";})
          .attr("x", 60)
          .attr("y", function(d) { return y(d); })
          .attr("dy", "15")
          .attr("class", "yAxisLeft")
          .attr("text-anchor", "end");

  var eventCanvas = svg.append('svg')
                  .attr('class', 'eventcanvas')
                  .attr('x', leftMargin)
                  .attr('width', eventCanvasWidth)
                  .attr('height', svgHeight);

  return;
};

var draw = function () {
// create eventsInHours object
var svg = d3.select('#svg-container')

if (events.length <= 1) {
  setup();
} else {
  // d3.select("svg.eventcanvas").remove();
  d3.select('svg').remove();
  setup();
}

var eventCanvas = d3.select('svg.eventcanvas');
console.log(eventCanvas);

eventsInHour = {};
createEventsInHours();

// sort by start time and THEN by duration

// this isn't strictly necessary but eliminates some edge cases
// currently where a long event that starts before everything
// else will be placed in the middle covering other events
events.sort(function(a, b) {
  if (a.start > b.start) {
    return 1;
  } else if (a.start < b.start) {
    return -1;
  } else {
    // they are equal
    if ((a.start - a.end) > (b.start - b.end)) {
      return 1;
    } else if ((a.start - a.end) < (b.start - b.end)) {
      return -1;
    }
  }

  return 0;
});


  var y = d3.time.scale()
            .domain([0,24])
            .range([0, svgHeight]);

  y.ticks(d3.time.hour, 1);


  // draw a rectangle event
  var eventRectangles = eventCanvas.selectAll('rect')
    .data(events)
     .enter().append('rect')
     .attr("fill", function() { return "hsl(" + Math.random() * 360 + ", 100%, 75%)" })
     .attr('stroke', '#333')
     .attr('stroke-width', 3)
     //.transition().duration(1000).delay(1000)
     .attr('y', function (d, index) { return y(d.start) + 2;})
     .attr('height', function (d, index) { return y((d.end - d.start + 1)); })
     .attr('width', function (d) { 
          // var elWidth = getWidth(d);
          // return elWidth;
          // console.log(d.width);
          var currentMin = eventCanvasWidth,
              minIndex   = 0;
          // go through get largest width
          for (var i=d.start;i<=d.end;i+=1) {
            if (eventsInHour[i].maxWidthPerElement < currentMin) {
              currentMin = eventsInHour[i].maxWidthPerElement;
              minIndex = i;
            }
          }
          // subtract this width from widthLeft in all hours


          console.log(d.name + ' ' + currentMin);
          return currentMin;
        })
     .attr('x', function (d, index) {
          var xPos = getWidth(d) * eventsInTimeframe(d, 'current');
          // if xPos is less than leftMargin we add to it so 
          // it won't cover text
          updateHours(d); // mark that we're placing it


          // should be 3px from 

          console.log(eventsInTimeframe(d, 'current'));
          d.location = xPos; // add location key to object for reference on the text
          return xPos;
        });

  // Draw y-axis labels of hours
  eventCanvas.selectAll("text")
          .data(events)
          .enter()
          .append("text")
          .text(function(d) { return d.name;})
          .attr('x', function (d, index) {

            return d.location + 100;
          })
          .attr('y', function (d, index) { return y(d.start) + 2;})
          .attr("dy", "15")
          .attr("class", "yAxisLeft")
          .attr("text-anchor", "end");    
  };


  // Click modal save button, create a new event
  $('#save-button').on('click', function () {
    // grab data from input boxes
    var start, end, name;

    start = Number($('#start').val());
    end   = Number($('#end').val());
    name  = $('#name').val();

    // close modal
    $('#myModal').modal('hide');

    // push data to events
    events.push({
      start: start,
      end  : end,
      name : name
    });

    // redraw map
    draw();
  });

  $('#randomize').on('click', function () {
    createRandomEvents();
    draw();
  });

});
</script>